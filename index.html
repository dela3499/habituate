<!DOCTYPE html>
<html lang="en">
<head>
    <title>Habits</title>
	<script src="mithril.js"></script>
	<link rel="stylesheet" type="text/css" href="app.css">
	<link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700" rel="stylesheet">
	<link 
	rel="stylesheet" 
	type="text/css" 
	href="font-awesome.min.css">
</head>

<body>
	<div id='container'>
		<div id="header">
			<div class="title">Habituate</div>
			<div class="item">build new habits</div>
			<div class="item small">
				made by <a target="_blank" href="https://twitter.com/dela3499">@dela3499</a> 
				/ fork on <a target="_blank" href="https://github.com/dela3499/habituate">GitHub</a></div>
		</div>
		<div id="all-habits">
		</div>	
	</div>
</body>

<script>

	// localStorage.clear('habituate')

	// Initialize localStorage
	

	// var local = localStorage.getItem('habituate')

	// if (!local) {
	// 	console.log("just set default");
	// 	localStorage.setItem('habituate', JSON.stringify(defaultModel));
	// }
	
	// Initialize UI



	defaultViewModel = {
		"daily": {
			"currentPeriodTitle": "Th 6/1",
			"currentPeriod": "",
			"previousPeriodTitle": "W 5/31",
			"previousPeriod": "",
			"habits": {
				0: {
					"id": 0,
					"title": "start walking by 6am",
					"currentPeriod": "complete",
					"previousPeriod": "complete",
					"periods": {}
				},
				1: {
					"id": 1,
					"title": "meditate 10m",
					"currentPeriod": "complete",
					"previousPeriod": "complete",
					"periods": {}
				},
				2: {
					"id": 2,
					"title": "business ideas 10m",
					"currentPeriod": "incomplete",
					"previousPeriod": "complete",
					"periods": {}
				},
				3: {
					"id": 3,
					"title": "read 10m",
					"currentPeriod": "incomplete",
					"previousPeriod": "complete",
					"periods": {}
				},
				4: {
					"id": 4,
					"title": "ship new product",
					"currentPeriod": "incomplete",
					"previousPeriod": "complete",
					"periods": {}
				},
				5: {
					"id": 5,
					"title": "newsletter",
					"currentPeriod": "incomplete",
					"previousPeriod": "complete",
					"periods": {}
				},
				6: {
					"id": 6,
					"title": "workout/stretch 10m",
					"currentPeriod": "incomplete",
					"previousPeriod": "complete",
					"periods": {}
				},
				7: {
					"id": 7,
					"title": "todos 10m",
					"currentPeriod": "incomplete",
					"previousPeriod": "complete",
					"periods": {}
				},
				8: {
					"id": 8,
					"title": "ship bioage",
					"currentPeriod": "incomplete",
					"previousPeriod": "incomplete",
					"periods": {}
				},
				9: {
					"id": 9,
					"title": "in bed by 11pm",
					"currentPeriod": "incomplete",
					"previousPeriod": "complete",
					"periods": {}
				}
			}
		}
	}

	function join(strings) {
		result = ""
		for (var i = strings.length - 1; i >= 0; i--) {
			result = result + strings[i] + " "
		}
		return result
	}

	function viewSection(sectionModel) {
		var header = [ 
			m('tr', 
				[ m('th', sectionModel['previousPeriodTitle']), 
				  m('th', sectionModel['currentPeriodTitle']),
				  m('th',"")
				]
			)]

		var allComplete = true			
		
		var rows = [0,1,2,3,4,5,6,7,8,9].map(function (habitID) {
			
			var habit = sectionModel['habits'][habitID]
			allComplete = allComplete & (habit['currentPeriod'] == 'complete')
			var warning = habit['currentPeriod'] == "incomplete" & habit['previousPeriod'] == "incomplete"
			var smallCongrats = habit['currentPeriod'] == "complete"
			var largeCongrats = habit['currentPeriod'] == "complete" & habit['previousPeriod'] == "incomplete"
		
			var currentText = ""
			var hoverText = ""

			if (warning){
				currentText = m("i", {class: "fa fa-warning big"})
				hoverText = "Don't skip two days in a row. Make the habit easier if you need, but make sure to do it."
			} else if (largeCongrats) {
				currentText = m("i", {class: "fa fa-thumbs-up big"})
				hoverText = "Nice! You skipped yesterday, but now you're back on the horse. :)"
			} else if (smallCongrats) {
				currentText = m("i", {class: "fa fa-thumbs-up"})
			}

			var previousPeriodClasses = join(['previousPeriod', habit['previousPeriod']])
			var currentPeriodClasses = join(['currentPeriod', habit['currentPeriod']])
			var labelClasses = join(['habit-title', habit['currentPeriod']])

			function togglePrevious() {
				update({
					action: 'toggleComplete', 
					habitType: 'daily', 
					habitID: habitID,
					period: 'previousPeriod'})
			}

			function toggleCurrent() {
				update({
					action: 'toggleComplete', 
					habitType: 'daily', 
					habitID: habitID,
					period: 'currentPeriod'})
			}

			function updateHabitTitle(input) {
				update({
					action: "setHabitTitle",
					habitType: 'daily',
					habitID: habitID,
					text: input.target.value
				})
			}

			return m("tr",
				[ m('td', {class: previousPeriodClasses, onclick: togglePrevious}, ""),
			      m('td', {class: currentPeriodClasses, onclick: toggleCurrent, title: hoverText}, currentText),
			      m('td', {class: labelClasses}, 
			      	m('input', {value: habit['title'], oninput: updateHabitTitle, placeholder: "enter habit here"})
			      	),
				])

		})

		var allCompleteClass = allComplete ? "all-complete" : ""

		return m('div', 
			{class: join(["section", allCompleteClass])},
			[ m('table', header.concat(rows)) ]
		)
	}

	function toggle(x) {
		if (x == "complete") {
			return "incomplete"
		} else {
			return "complete"
		}
	}

	function update(action) {

		viewModel = JSON.parse(localStorage.getItem('habituate'))

		if (action['action'] == 'toggleComplete') {
			habitType = action['habitType']
			habitID = action['habitID']
			period = action['period']
			viewModel[habitType]['habits'][habitID][period] = toggle(viewModel[habitType]['habits'][habitID][period])

			periodName = viewModel[habitType][period]
			viewModel[habitType]['habits'][habitID]["periods"][periodName] = viewModel[habitType]['habits'][habitID][period]

		} else if (action['action'] == 'setHabitTitle') {
			habitType = action['habitType']
			habitID = action['habitID']
			text = action['text']
			viewModel[habitType]['habits'][habitID]['title'] = text
		}
		localStorage.setItem('habituate', JSON.stringify(viewModel));
		render()
	}

	function shiftDate(date, nDays) {
		return new Date(new Date().setDate(date.getDate() + nDays))
	}

	function getDayString(dateString) {
		date = new Date(dateString)
		dayOfWeek = ['Su','M','Tu','W','Th','F','Sa'][date.getDay()]
		month = date.getMonth() + 1
		dayOfMonth = date.getDate()

		return dayOfWeek + " " + month.toString() + "/" + dayOfMonth.toString()
	}

	function init() {
		// prepare localstorage
		var model = JSON.parse(localStorage.getItem('habituate'))
		if (!model) {
			console.log("setting default model")
			model = defaultViewModel
			// localStorage.setItem('habituate', JSON.stringify(defaultViewModel));
		}

		var todayDate = shiftDate(new Date(), 10)
		var today = todayDate.toDateString()
		var yesterdayDate = shiftDate(todayDate, -1)
		var yesterday = yesterdayDate.toDateString()

		// check if today & yesterday are present in daily habits
		var dummy = [0,1,2,3,4,5,6,7,8,9].map(function(habitID) {

			todaysHabitStatus = model['daily']['habits'][habitID]['periods'][today]
			console.log(todaysHabitStatus)
			yesterdaysHabitStatus = model['daily']['habits'][habitID]['periods'][yesterday]
			if (!todaysHabitStatus) {
				model['daily']['habits'][habitID]['periods'][today] = "incomplete"
			}
			if (!yesterdaysHabitStatus) {
				model['daily']['habits'][habitID]['periods'][yesterday] = "complete"
			}
			model['daily']['habits'][habitID]["previousPeriod"] = model['daily']['habits'][habitID]['periods'][yesterday]
			model['daily']['habits'][habitID]["currentPeriod"] = model['daily']['habits'][habitID]['periods'][today]
			
			model['daily']['currentPeriod'] = today
			model['daily']['previousPeriod'] = yesterday

			model['daily']['currentPeriodTitle'] = getDayString(today)
			model['daily']['previousPeriodTitle'] = getDayString(yesterday)
		})

		localStorage.setItem('habituate', JSON.stringify(model));
	}

	// localStorage.clear('habituate')

	function render() {
		var root = document.getElementById("all-habits")
		var model = JSON.parse(localStorage.getItem('habituate'))
		m.render(root, viewSection(model['daily']))
	}

	init()
	render()



</script>

</html>

<!-- regularly update time, i guess. Not just on startup.  -->